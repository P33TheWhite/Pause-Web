<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout :: layout(~{::main}, ~{::link})}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <main class="container py-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <a th:href="@{${backLink}}" class="btn btn-light border shadow-sm rounded-circle p-2" title="Retour">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-arrow-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
                    </svg>
                </a>
                <div>
                    <h1 class="fw-bold mb-0" th:text="${event.titre}">Titre de l'√©v√©nement</h1>
                    <div class="text-muted d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                            class="bi bi-calendar-event" viewBox="0 0 16 16">
                            <path
                                d="M11 6.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z" />
                            <path
                                d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z" />
                        </svg>
                        <span th:text="${#temporals.format(event.date, 'EEEE d MMMM yyyy')}">Date</span>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <a th:href="@{/admin/event/{id}/edit(id=${event.id})}"
                    class="btn btn-outline-warning d-flex align-items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-pencil-square" viewBox="0 0 16 16">
                        <path
                            d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                        <path fill-rule="evenodd"
                            d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
                    </svg>
                    Modifier
                </a>
                <form th:unless="${event.estArchive}" th:action="@{/admin/event/{id}/archive(id=${event.id})}"
                    method="post" onsubmit="return confirm('√ätes-vous s√ªr de vouloir cl√¥turer cet √©v√©nement ?');">
                    <input type="hidden" name="_method" value="delete" />
                    <button type="submit" class="btn btn-danger d-flex align-items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi bi-archive-fill" viewBox="0 0 16 16">
                            <path
                                d="M12.643 15C13.979 15 15 13.845 15 12.5V5H1v7.5C1 13.845 2.021 15 3.357 15h9.286zM5.5 7h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1zM.8 1a.8.8 0 0 0-.8.8V3a.8.8 0 0 0 .8.8h14.4A.8.8 0 0 0 16 3V1.8a.8.8 0 0 0-.8-.8H.8z" />
                        </svg>
                        Cl√¥turer
                    </button>
                </form>
            </div>
        </div>


        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="admin-metric-card">
                    <div>
                        <div class="metric-value" th:text="${stats['nbInscrits']}">0</div>
                        <div class="metric-label">Inscrits</div>
                    </div>
                    <div class="metric-icon users">üë•</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-metric-card">
                    <div>
                        <div class="metric-value text-success" th:text="${stats['nbPaye']}">0</div>
                        <div class="metric-label">Ont Pay√©</div>
                    </div>
                    <div class="metric-icon pending" style="background-color: rgba(25, 135, 84, 0.1); color: #198754;">
                        üí∞</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-metric-card">
                    <div>
                        <div class="metric-value text-primary"
                            th:text="${#numbers.formatDecimal(stats['recettes'], 1, 2) + ' ‚Ç¨'}">0 ‚Ç¨</div>
                        <div class="metric-label">Recettes</div>
                    </div>
                    <div class="metric-icon" style="background-color: rgba(13, 110, 253, 0.1); color: #0d6efd;">
                        üìà</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-metric-card">
                    <div>
                        <div class="metric-value text-warning" th:text="${stats['nbRepas']}">0</div>
                        <div class="metric-label">Repas Servis</div>
                    </div>
                    <div class="metric-icon events" style="background-color: rgba(255, 193, 7, 0.1); color: #ffc107;">
                        üçΩÔ∏è</div>
                </div>
            </div>
        </div>


        <div class="card border-0 shadow-sm mb-5">
            <div class="card-body d-flex justify-content-between align-items-center p-4">
                <div class="d-flex align-items-center gap-3">
                    <div class="bg-light p-3 rounded-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                            class="bi bi-cart-check text-muted" viewBox="0 0 16 16">
                            <path
                                d="M11.354 6.354a.5.5 0 0 0-.708-.708L8 8.293 6.854 7.146a.5.5 0 1 0-.708.708l1.5 1.5a.5.5 0 0 0 .708 0l3-3z" />
                            <path
                                d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1H.5zm3.915 10L3.102 4h10.796l-1.313 7h-8.17zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z" />
                        </svg>
                    </div>
                    <div>
                        <h5 class="mb-0 fw-bold">Co√ªt des Courses</h5>
                        <small class="text-muted">Saisissez le montant total des d√©penses pour cet √©v√©nement.</small>
                    </div>
                </div>
                <form method="post" th:action="@{/admin/event/{id}/update-cost(id=${event.id})}"
                    class="d-flex align-items-center gap-2">
                    <input type="hidden" name="_method" value="put" />
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">‚Ç¨</span>
                        <input type="number" step="0.01" name="coutCourses" class="form-control border-start-0 ps-0"
                            th:value="${event.coutCourses}" style="width: 120px; font-weight: bold;" placeholder="0.00">
                    </div>
                    <input type="hidden" name="source" th:value="${param.source}">
                    <button class="btn btn-asso shadow-sm">Enregistrer</button>
                </form>
            </div>
        </div>


        <div class="card border-0 shadow-sm mb-5">
            <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Gestion du Staff</h5>
                <form method="post" th:action="@{/admin/event/{id}/validate-staff(id=${event.id})}">
                    <button type="submit" class="btn btn-primary btn-sm">Valider les points Staff</button>
                </form>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th>Ordre</th>
                                <th>Staffeur</th>
                                <th>Points pr√©vus</th>
                                <th>Statut</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="ins, stat : ${staffInscriptions}">
                                <td>
                                    <span class="badge rounded-pill bg-light text-dark border"
                                        th:text="'#' + ${stat.count}">#1</span>
                                </td>
                                <td class="fw-bold" th:text="${ins.utilisateur.nom} + ' ' + ${ins.utilisateur.prenom}">
                                    Nom</td>
                                <td>
                                    <span th:if="${stat.count <= 3}" class="text-success fw-bold">+50 pts</span>
                                    <span th:if="${stat.count > 3 && stat.count <= 7}" class="text-primary fw-bold">+30
                                        pts</span>
                                    <span th:if="${stat.count > 7}" class="text-secondary fw-bold">+10 pts</span>
                                </td>
                                <td>
                                    <span th:if="${ins.staffValide}" class="badge bg-success">Valid√©</span>
                                    <span th:if="${!ins.staffValide}" class="badge bg-warning text-dark">En
                                        attente</span>
                                </td>
                                <td>
                                    <form method="post"
                                        th:action="@{/admin/event/{id}/staff/{userId}/remove(id=${event.id}, userId=${ins.utilisateur.id})}"
                                        onsubmit="return confirm('Attention : cela va d√©sinscrire totalement cet utilisateur de l\'√©v√©nement. Confirmer ?');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                            title="Ne a pas staff√© / D√©sinscrire">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                                <path
                                                    d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z" />
                                            </svg>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <tr th:if="${staffInscriptions.isEmpty()}">
                                <td colspan="4" class="text-center text-muted py-3">Aucun staffeur inscrit pour le
                                    moment.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold">Liste des Inscrits</h5>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-light border-end-0">üîç</span>
                    <input type="text" id="searchBar" class="form-control border-start-0 ps-0"
                        placeholder="Rechercher..." onkeyup="filtrerTableau()">
                </div>
            </div>
            <div class="table-responsive">
                <table class="table admin-table mb-0 align-middle" id="tableInscrits">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Membre</th>
                            <th>Classe</th>
                            <th>Statut Asso</th>
                            <th>√Ä Payer</th>
                            <th class="text-center">A Pay√©</th>
                            <th class="text-center pe-4">A Mang√©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="ins : ${inscriptions}">
                            <td class="ps-4">
                                <div class="fw-bold nom-prenom"
                                    th:text="${ins.utilisateur.nom} + ' ' + ${ins.utilisateur.prenom}">Nom</div>
                            </td>
                            <td class="text-muted" th:text="${ins.utilisateur.classe}">Classe</td>
                            <td>
                                <span th:if="${ins.utilisateur.estCotisant}"
                                    class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Cotisant</span>
                                <span th:if="${!ins.utilisateur.estCotisant}"
                                    class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill">Non
                                    Cotisant</span>
                            </td>
                            <td class="fw-bold text-dark" th:text="${ins.montantAPayer} + ' ‚Ç¨'">0 ‚Ç¨</td>

                            <form method="post" th:action="@{/admin/inscription/{id}/update(id=${ins.id})}">
                                <input type="hidden" name="source" th:value="${param.source}">
                                <td class="text-center">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" name="aPaye"
                                            th:checked="${ins.aPaye}" onchange="this.form.submit()"
                                            style="cursor: pointer; width: 1.2em; height: 1.2em;">
                                    </div>
                                </td>
                                <td class="text-center pe-4">
                                    <div class="form-check d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox" name="aMange"
                                            th:checked="${ins.aRecupereRepas}" onchange="this.form.submit()"
                                            style="cursor: pointer; width: 1.2em; height: 1.2em;">
                                    </div>
                                </td>
                            </form>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script>
            function filtrerTableau() {
                let input = document.getElementById("searchBar").value.toLowerCase();
                let rows = document.querySelectorAll("#tableInscrits tbody tr");
                rows.forEach(row => {
                    let name = row.querySelector(".nom-prenom").innerText.toLowerCase();
                    row.style.display = name.includes(input) ? "" : "none";
                });
            }
        </script>
    </main>
</th:block>

</html>