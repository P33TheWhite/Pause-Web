<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout :: layout(~{::main}, ~{::link})}">
    <link rel="stylesheet" th:href="@{/css/gallery.css}">
    <main class="container mt-5">
        <a href="/agenda" class="btn btn-outline-secondary mb-4">‚Üê Retour √† l'agenda</a>

        <div class="row">
            <!-- Colonne Image -->
            <div class="col-md-6 mb-4">
                <div class="card shadow-sm border-0 overflow-hidden">
                    <img th:if="${event.photoUrl != null}" th:src="${event.photoUrl}" class="img-fluid"
                        alt="Event photo" style="width: 100%; height: 400px; object-fit: cover;">
                    <img th:if="${event.photoUrl == null && !event.photos.isEmpty()}" th:src="${event.photos[0].url}"
                        class="img-fluid" alt="Event photo" style="width: 100%; height: 400px; object-fit: cover;">
                    <div th:if="${event.photoUrl == null && event.photos.isEmpty()}"
                        class="d-flex align-items-center justify-content-center bg-light" style="height: 400px;">
                        <span style="font-size: 5rem;">üéâ</span>
                    </div>
                </div>
            </div>

            <!-- Colonne D√©tails -->
            <div class="col-md-6">
                <h1 class="fw-bold mb-3" th:text="${event.titre}">Titre de l'√©v√©nement</h1>

                <div class="mb-3">
                    <span th:each="type : ${event.types}" class="badge bg-warning text-dark me-2 fs-6"
                        th:text="${type.libelle}">Type</span>
                </div>

                <h4 class="text-muted mb-4">
                    üóì <span th:text="${event.dateEvenement}">Date</span>
                    <span th:if="${event.heureDebut != null}" th:text="' | üïí ' + ${event.heureDebut}"></span>
                    <span th:if="${event.heureFin != null}" th:text="' - ' + ${event.heureFin}"></span>
                </h4>

                <div class="card bg-light border-0 p-3 mb-4">
                    <h5 class="fw-bold">Tarifs</h5>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Cotisant :</span>
                        <span class="fw-bold text-success fs-5" th:text="${event.prixCotisant} + ' ‚Ç¨'"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Non-Cotisant :</span>
                        <span class="fw-bold text-danger fs-5" th:text="${event.prixNonCotisant} + ' ‚Ç¨'"></span>
                    </div>
                </div>

                <div class="mb-4">
                    <h5 class="fw-bold">Places</h5>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-info" role="progressbar"
                            th:style="'width: ' + (${event.nbPlacesMax != null && event.nbPlacesMax > 0 ? (nbInscrits * 100 / event.nbPlacesMax) : 100}) + '%'"
                            th:text="${nbInscrits} + ' inscrits'">
                        </div>
                    </div>
                    <p class="text-muted" th:if="${event.nbPlacesMax != null}">
                        Sur <span th:text="${event.nbPlacesMax}"></span> places disponibles.
                    </p>
                </div>

                <p class="lead" th:text="${event.description}">Description d√©taill√©e...</p>

                <div class="d-grid gap-2 mt-4">
                    <a th:if="${event.lienPaiement != null && !event.lienPaiement.isEmpty()}"
                        th:href="${event.lienPaiement}" target="_blank" class="btn btn-primary btn-lg">
                        üí≥ Payer ma place (Lien Externe)
                    </a>

                    <div th:if="${session.user == null}">
                        <a href="/login" class="btn btn-asso btn-lg">Se connecter pour s'inscrire</a>
                    </div>

                    <div th:if="${session.user != null}">
                        <div th:if="${estInscrit}">
                            <div class="d-flex align-items-center mb-3 flex-wrap gap-2">
                                <button class="btn btn-success btn-lg" disabled th:if="${!inscriptionEnAttente}">‚úÖ
                                    Vous √™tes inscrit !</button>
                                <button class="btn btn-warning btn-lg" disabled th:if="${inscriptionEnAttente}">‚è≥
                                    En liste d'attente</button>

                                <!-- Staff Toggle Buttons -->
                                <div th:if="${session.user.estStaffeur}">
                                    <!-- If registered but NOT staff yet -->
                                    <form th:if="${!estStaff}" method="post"
                                        th:action="@{/event/{id}/staff(id=${event.id})}">
                                        <button type="submit" class="btn btn-outline-dark btn-lg">
                                            <i class="bi bi-person-badge me-2"></i>Rejoindre en tant que Staffeur
                                        </button>
                                    </form>

                                    <!-- If ALREADY staff -->
                                    <form th:if="${estStaff}" method="post"
                                        th:action="@{/event/{id}/unstaff(id=${event.id})}">
                                        <button type="submit" class="btn btn-outline-warning btn-lg">
                                            <i class="bi bi-person-x me-2"></i>Annuler le Staff
                                        </button>
                                    </form>
                                </div>

                                <form method="post" th:action="@{/event/{id}/unregister(id=${event.id})}">
                                    <button type="submit" class="btn btn-outline-danger btn-lg">Se d√©sinscrire</button>
                                </form>
                            </div>
                        </div>

                        <form th:if="${!estInscrit}" method="post" th:action="@{/event/{id}/register(id=${event.id})}">

                            <div th:if="${session.user.estStaffeur}" class="mb-3">
                                <button type="submit" formaction="/event/{id}/staff"
                                    class="btn btn-outline-dark btn-lg w-100">
                                    <i class="bi bi-person-badge me-2"></i>Staffer cet √©v√©nement
                                </button>
                                <div class="text-center small text-muted mt-1">En tant que staff, vous ne payez pas
                                    l'entr√©e.</div>
                            </div>

                            <button type="submit" class="btn btn-asso btn-lg"
                                th:text="${event.nbPlacesMax != null && nbInscrits >= event.nbPlacesMax ? 'S''inscrire (Liste d''attente)' : 'S''inscrire sur le site'}">
                                S'inscrire sur le site
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
</th:block>

</html>